import React, { useState, useEffect } from 'react';
import { 
  Trophy, Users, User, Wallet, MessageSquare, Shield, 
  Gamepad2, Calendar, CreditCard, ChevronRight, Lock, 
  Unlock, Send, Search, CheckCircle, AlertTriangle, 
  Menu, X, Share2, Youtube, Instagram, Facebook, Gift, Check, Flame, Zap, Crosshair, Crown, Target, Banknote, Clock, TrendingUp, Clock2, UserPlus, Copy, Key, Settings, Edit3, Image as ImageIcon, Upload
} from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInAnonymously, onAuthStateChanged, signOut 
} from 'firebase/auth';
import { 
  getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, increment, serverTimestamp 
} from 'firebase/firestore';

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyAUhjITeMcVcEbgvvgbZ-VYgDC0q948kJY",
  authDomain: "mk-esports-69e15.firebaseapp.com",
  projectId: "mk-esports-69e15",
  storageBucket: "mk-esports-69e15.firebasestorage.app",
  messagingSenderId: "87847566694",
  appId: "1:87847566694:web:a32a596c8991d42a6b1ca7",
  measurementId: "G-1E9EDPXNC2"
};

// --- CONSTANTS ---
const ADMIN_NUMBER = "0000"; 
const ADMIN_UPI_ID = '6394562344-@ybl';
const QR_PLACEHOLDER_URL = 'https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg'; // Replace with your actual QR URL
const PRESET_AMOUNTS = [50, 100, 200, 500, 1000, 2000];

const IMAGES = {
    SOLO: "https://images.unsplash.com/photo-1614680376593-902f74cf0d41?q=80&w=1974&auto=format&fit=crop", 
    DUO: "https://images.unsplash.com/photo-1642387994262-ba9223e7161b?q=80&w=2070&auto=format&fit=crop", 
    SQUAD: "https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=2070&auto=format&fit=crop", 
    PER_KILL: "https://images.unsplash.com/photo-1509198397868-475647b2a1e5?q=80&w=1947&auto=format&fit=crop", 
    LAN: "https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=2071&auto=format&fit=crop"
};

const getFutureTime = (minutes) => Date.now() + minutes * 60 * 1000;

// --- MATCH DATA ---
const INITIAL_MATCHES = [
  { id: 'sq_10am', title: 'Morning Squad Rush', mode: 'SQUAD', entryFee: 150, prizePool: '₹1,500', map: 'Bermuda', time: '10:40 AM', startTimeMs: getFutureTime(30), joined: 8, totalSlots: 12, type: 'online', image: IMAGES.SQUAD, roomId: "", roomPass: "" },
  { id: 'sq_2pm', title: 'Afternoon Warfare', mode: 'SQUAD', entryFee: 150, prizePool: '₹1,500', map: 'Purgatory', time: '02:00 PM', startTimeMs: getFutureTime(240), joined: 2, totalSlots: 12, type: 'online', image: IMAGES.SQUAD, roomId: "", roomPass: "" },
  { id: 'sl_11am', title: 'Solo Sniper Only', mode: 'SOLO', entryFee: 50, prizePool: '₹2,000', map: 'Bermuda', time: '11:00 AM', startTimeMs: getFutureTime(60), joined: 42, totalSlots: 48, type: 'online', image: IMAGES.SOLO, roomId: "", roomPass: "" },
  { id: 'du_4pm', title: 'Duo Deathmatch', mode: 'DUO', entryFee: 150, prizePool: '₹2,000', map: 'Purgatory', time: '04:00 PM', startTimeMs: getFutureTime(360), joined: 20, totalSlots: 24, type: 'online', image: IMAGES.DUO, roomId: "", roomPass: "" },
  { id: 'lan1', title: 'MK LAN MEGA EVENT', mode: 'LAN', entryFee: 500, prizePool: '₹1,00,000', map: 'Delhi Arena', time: 'Dec 25th', startTimeMs: getFutureTime(100000), joined: 184, totalSlots: 1000, type: 'lan', image: IMAGES.LAN, roomId: "", roomPass: "" }
];

// --- COMPONENTS ---

const CountdownTimer = ({ targetTimeMs }) => {
    const [timeLeft, setTimeLeft] = useState(targetTimeMs - Date.now());
    useEffect(() => {
        const interval = setInterval(() => setTimeLeft(targetTimeMs - Date.now()), 1000);
        return () => clearInterval(interval);
    }, [targetTimeMs]);

    const formatTime = (ms) => {
        if (ms <= 0) return 'LIVE NOW';
        const hours = Math.floor(ms / 3600000);
        const minutes = Math.floor((ms % 3600000) / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        return `${hours}h ${minutes}m ${seconds}s`;
    };
    const color = timeLeft < 900000 && timeLeft > 0 ? 'text-red-400 animate-pulse' : 'text-cyan-400';
    return <span className={`flex items-center gap-1 font-mono text-[10px] font-bold ${color}`}><Clock2 size={10} className={color} /> {formatTime(timeLeft)}</span>;
};

const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
  const baseStyle = "relative font-black uppercase tracking-wider transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 overflow-hidden clip-path-slant";
  const variants = {
    primary: "bg-cyan-600 text-black hover:bg-cyan-400 py-3 px-4 text-sm",
    secondary: "bg-black/60 text-cyan-400 border border-cyan-500/50 py-2 px-3 text-xs",
    claim: "bg-gradient-to-r from-yellow-400 to-orange-500 text-black py-3 px-4 text-sm animate-pulse",
    danger: "bg-red-600/20 text-red-500 border border-red-500/50 py-3 px-4 text-sm",
    success: "bg-emerald-600 text-black hover:bg-emerald-400 py-3 px-4 text-sm"
  };
  return (
    <button onClick={onClick} disabled={disabled} style={{clipPath: "polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px)"}} className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 grayscale' : ''} ${className}`}>
       {children}
    </button>
  );
};

const Card3D = ({ children, className = '', glow = 'cyan', image }) => {
  const glowColors = {
    cyan: 'border-cyan-500/50 shadow-[0_10px_30px_rgba(6,182,212,0.15)]',
    gold: 'border-yellow-500/50 shadow-[0_10px_30px_rgba(234,179,8,0.15)]',
  };
  return (
    <div className={`relative bg-slate-950 rounded-2xl border overflow-hidden group hover:scale-[1.01] transition-transform ${glowColors[glow]} ${className}`}>
      {image && <div className="absolute inset-0 z-0"><img src={image} className="w-full h-full object-cover opacity-40 mix-blend-overlay" /></div>}
      <div className="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-950/90 to-transparent z-0"></div>
      <div className="relative z-20 p-4">{children}</div>
    </div>
  );
};

// --- MAIN APP ---

export default function MKEsportsUltimate() {
  const [user, setUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [view, setView] = useState('home');
  const [matches, setMatches] = useState(INITIAL_MATCHES);
  const [userProfile, setUserProfile] = useState(null);
  const [loading, setLoading] = useState(true);
  const [mobileNumber, setMobileNumber] = useState('');
  const [activeTab, setActiveTab] = useState('ALL');

  // Join States
  const [showJoinModal, setShowJoinModal] = useState(false);
  const [joiningMatch, setJoiningMatch] = useState(null);
  const [playerDetails, setPlayerDetails] = useState([]);

  // Wallet States
  const [depositAmount, setDepositAmount] = useState('');
  const [utrNumber, setUtrNumber] = useState('');
  const [proofImage, setProofImage] = useState(null);
  const [pendingDeposits, setPendingDeposits] = useState([]);

  useEffect(() => {
    signInAnonymously(auth);
    onAuthStateChanged(auth, async (u) => {
        if(u) {
            setUser(u);
            const ref = doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'main');
            onSnapshot(ref, (s) => {
                if(s.exists()) {
                    setUserProfile(s.data());
                    if(s.data().isAdmin) setIsAdmin(true);
                }
            });
        }
        setLoading(false);
    });
  }, []);

  const handleLogin = async () => {
    if(!mobileNumber) return;
    setLoading(true);
    if(mobileNumber === ADMIN_NUMBER) {
        if(user) await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), { displayName: "MASTER ADMIN", walletBalance: 999999, isAdmin: true, myMatches: [] }, {merge: true});
    } else if(user) {
         const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
         const snap = await getDoc(ref);
         if(!snap.exists()) await setDoc(ref, { displayName: `Player_${mobileNumber.slice(-4)}`, walletBalance: 50, matchesPlayed: 0, myMatches: [] });
    }
    setLoading(false);
  };

  const handleJoin = (match) => {
      if(!userProfile) return;
      if(userProfile.myMatches?.includes(match.id)) { alert("Already Joined!"); return; }
      if(userProfile.walletBalance < match.entryFee) { alert("Insufficient Balance!"); setView('wallet'); return; }
      
      setJoiningMatch(match);
      let count = 1;
      if(match.mode === 'DUO') count = 2;
      if(match.mode === 'SQUAD') count = 4;

      const initialPlayers = Array(count).fill().map((_, i) => ({ 
          name: i===0 ? userProfile.displayName : '', uid: '' 
      }));
      setPlayerDetails(initialPlayers);
      setShowJoinModal(true);
  };

  const updatePlayer = (index, field, value) => {
      const newDetails = [...playerDetails];
      newDetails[index][field] = value;
      setPlayerDetails(newDetails);
  };

  const confirmJoin = async () => {
      const isValid = playerDetails.every(p => p.name.trim() !== '' && p.uid.trim() !== '');
      if(!isValid) { alert("Please fill details for ALL players!"); return; }

      const ref = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
      await updateDoc(ref, {
          walletBalance: increment(-joiningMatch.entryFee),
          myMatches: [...(userProfile.myMatches || []), joiningMatch.id]
      });
      const updatedMatches = matches.map(m => m.id === joiningMatch.id ? {...m, joined: m.joined + 1} : m);
      setMatches(updatedMatches);
      setShowJoinModal(false);
      alert(`${joiningMatch.mode} Joined Successfully!`);
  };

  // --- WALLET LOGIC ---
  const handleDepositSubmit = () => {
      if(!depositAmount || parseInt(depositAmount) < 50) { alert("Minimum deposit is ₹50"); return; }
      if(!utrNumber || utrNumber.length !== 12) { alert("UTR Number must be exactly 12 Digits!"); return; }
      if(!proofImage) { alert("Please upload payment screenshot!"); return; }

      // In real app, upload image to storage here
      const newDeposit = {
          amount: depositAmount,
          utr: utrNumber,
          user: userProfile.displayName,
          proof: proofImage, // Assuming local URL for demo
          timestamp: new Date().toLocaleString(),
          id: Date.now()
      };

      setPendingDeposits([...pendingDeposits, newDeposit]);
      setDepositAmount('');
      setUtrNumber('');
      setProofImage(null);
      alert("Deposit Request Sent! Admin will verify UTR & Screenshot.");
  };

  const handleProofUpload = (e) => {
      if(e.target.files && e.target.files[0]) {
          // Creating a fake local URL for preview
          setProofImage(URL.createObjectURL(e.target.files[0]));
      }
  };

  const approveDeposit = async (deposit) => {
      alert(`Deposit of ₹${deposit.amount} Approved for ${deposit.user}`);
      setPendingDeposits(pendingDeposits.filter(d => d.id !== deposit.id));
      // In real app, update user wallet in DB
  };

  // --- VIEWS ---
  const HomeView = () => {
    const filtered = activeTab === 'ALL' ? matches : matches.filter(m => m.mode === activeTab || (activeTab === 'LAN' && m.type === 'lan'));
    return (
      <div className="pb-24 pt-4 px-2 space-y-4">
          <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
            {['ALL', 'SOLO', 'DUO', 'SQUAD', 'LAN'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 text-[10px] font-bold tracking-widest uppercase transition-all duration-300 rounded-lg whitespace-nowrap ${activeTab === tab ? 'bg-cyan-600 text-black shadow-lg shadow-cyan-500/40' : 'bg-slate-900 border border-slate-800 text-slate-500'}`}>{tab}</button>
            ))}
          </div>
          {filtered.map(match => (
              <Card3D key={match.id} image={match.image} glow={match.type === 'lan' ? 'gold' : 'cyan'}>
                  <div className="flex justify-between items-start mb-4 relative z-10">
                      <div className="flex flex-col gap-1">
                          <span className="bg-cyan-900/80 text-cyan-400 px-2 py-1 text-[10px] font-bold uppercase rounded border border-cyan-500/50 w-fit">{match.mode}</span>
                          <span className="text-[10px] text-yellow-400 font-bold border border-yellow-500/30 bg-black/50 px-2 py-0.5 rounded w-fit">TIME: {match.time}</span>
                      </div>
                      <div className="text-right bg-black/60 p-2 rounded border border-white/10">
                          <p className="text-[9px] text-slate-400 uppercase font-bold">Prize</p>
                          <p className="text-lg font-black text-emerald-400">{match.prizePool}</p>
                      </div>
                  </div>
                  <h3 className="text-xl font-black text-white italic">{match.title}</h3>
                  <div className="mt-4 flex items-end gap-3 relative z-10">
                      <div className="flex-1">
                          <div className="flex justify-between text-[10px] mb-1 font-bold text-slate-400">
                              <span>SLOTS: {match.joined}/{match.totalSlots}</span>
                          </div>
                          <div className="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                              <div className="h-full bg-cyan-500" style={{width: `${(match.joined/match.totalSlots)*100}%`}}></div>
                          </div>
                      </div>
                      <Button onClick={() => handleJoin(match)} disabled={match.type === 'lan'} variant={userProfile?.myMatches?.includes(match.id) ? 'secondary' : 'primary'}>
                          {userProfile?.myMatches?.includes(match.id) ? 'JOINED' : `JOIN ₹${match.entryFee}`}
                      </Button>
                  </div>
              </Card3D>
          ))}
      </div>
    );
  };

  const WalletView = () => (
      <div className="pb-24 pt-4 px-2 space-y-6">
          <Card3D glow="gold" className="text-center py-6">
              <p className="text-slate-400 text-xs font-bold uppercase">Balance</p>
              <h2 className="text-4xl font-black text-white mt-1">₹{userProfile?.walletBalance}</h2>
          </Card3D>

          {isAdmin ? (
              <div className="bg-red-950/30 border border-red-500/50 p-4 rounded-xl">
                  <h3 className="text-red-400 font-bold mb-4 flex items-center gap-2"><Shield size={16}/> ADMIN: VERIFY DEPOSITS</h3>
                  {pendingDeposits.length > 0 ? (
                      pendingDeposits.map((d, i) => (
                          <div key={i} className="bg-black/50 p-3 rounded-lg mb-2 border border-slate-700">
                              <div className="flex justify-between mb-2">
                                  <span className="text-xs text-white font-bold">{d.user}</span>
                                  <span className="text-emerald-400 font-bold">+₹{d.amount}</span>
                              </div>
                              <div className="text-[10px] text-slate-400 font-mono mb-2">UTR: {d.utr}</div>
                              {d.proof && <img src={d.proof} className="w-full h-32 object-contain bg-black border border-slate-800 mb-2 rounded"/>}
                              <div className="flex gap-2">
                                  <Button size="sm" variant="success" className="w-full py-1" onClick={() => approveDeposit(d)}>APPROVE</Button>
                                  <Button size="sm" variant="danger" className="w-full py-1">REJECT</Button>
                              </div>
                          </div>
                      ))
                  ) : <div className="text-xs text-slate-500">No Pending Requests</div>}
              </div>
          ) : (
              <Card3D glow="cyan">
                  <h3 className="font-bold text-white mb-4 flex items-center gap-2"><TrendingUp size={18} className="text-emerald-400"/> DEPOSIT MONEY</h3>
                  
                  {/* SCANNER SECTION */}
                  <div className="bg-white p-3 w-40 h-40 mx-auto mb-3 rounded-xl shadow-lg shadow-cyan-500/20">
                     <img src={QR_PLACEHOLDER_URL} className="w-full h-full object-contain" />
                  </div>
                  <div className="flex items-center justify-center gap-2 mb-6">
                      <span className="text-cyan-400 font-mono font-bold bg-slate-900 px-3 py-1 rounded border border-cyan-500/30">{ADMIN_UPI_ID}</span>
                      <button onClick={() => navigator.clipboard.writeText(ADMIN_UPI_ID)} className="bg-slate-800 p-1.5 rounded text-white"><Copy size={14}/></button>
                  </div>

                  {/* PRESET AMOUNTS */}
                  <div className="grid grid-cols-3 gap-2 mb-4">
                      {PRESET_AMOUNTS.map(amt => (
                          <button key={amt} onClick={() => setDepositAmount(amt.toString())} 
                            className={`py-2 rounded font-bold text-xs border ${depositAmount === amt.toString() ? 'bg-cyan-600 text-black border-cyan-400' : 'bg-slate-900 text-slate-400 border-slate-700'}`}>
                              ₹{amt}
                          </button>
                      ))}
                  </div>

                  {/* FORM */}
                  <div className="space-y-3">
                      <div className="relative">
                         <span className="absolute left-3 top-3 text-slate-500 font-bold">₹</span>
                         <input type="number" value={depositAmount} onChange={e => setDepositAmount(e.target.value)} placeholder="Amount" className="w-full bg-black border border-slate-700 rounded-lg p-3 pl-8 text-white outline-none focus:border-cyan-500 font-bold" />
                      </div>
                      
                      <div>
                          <input type="number" value={utrNumber} onChange={e => {if(e.target.value.length <= 12) setUtrNumber(e.target.value)}} placeholder="Enter 12-Digit UTR Number" className="w-full bg-black border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-cyan-500 font-mono font-bold text-xs" />
                          <p className="text-[9px] text-right text-slate-500 mt-1">{utrNumber.length}/12 Digits</p>
                      </div>

                      <div className="border border-dashed border-slate-700 rounded-lg p-4 text-center hover:border-cyan-500/50 transition-colors cursor-pointer relative">
                          <input type="file" accept="image/*" onChange={handleProofUpload} className="absolute inset-0 opacity-0 cursor-pointer" />
                          {proofImage ? (
                              <div className="flex items-center justify-center gap-2 text-emerald-400 text-xs font-bold">
                                  <CheckCircle size={14} /> Screenshot Added
                              </div>
                          ) : (
                              <div className="flex flex-col items-center gap-1 text-slate-500">
                                  <ImageIcon size={20} />
                                  <span className="text-[10px] uppercase font-bold">Upload Payment Screenshot</span>
                              </div>
                          )}
                      </div>

                      <Button onClick={handleDepositSubmit} className="w-full mt-2" variant="success">VERIFY & DEPOSIT</Button>
                  </div>
              </Card3D>
          )}
      </div>
  );

  if(!user || !userProfile) {
      return (
          <div className="min-h-screen bg-black flex flex-col items-center justify-center p-6">
              <div className="w-20 h-20 bg-cyan-600 mb-6 flex items-center justify-center font-black text-3xl italic clip-path-slant">MK</div>
              <h1 className="text-3xl font-black text-white mb-8">LOGIN</h1>
              <input value={mobileNumber} onChange={e=>setMobileNumber(e.target.value)} placeholder="Mobile Number" className="w-full bg-slate-900 border border-slate-700 p-4 text-white font-mono rounded-lg mb-4 outline-none focus:border-cyan-500" />
              <Button onClick={handleLogin} className="w-full py-4">ENTER ARENA</Button>
          </div>
      );
  }

  return (
    <div className="min-h-screen bg-slate-950 text-slate-300 font-sans relative overflow-hidden">
      <div className="sticky top-0 z-40 bg-slate-950/90 backdrop-blur-md border-b border-white/10 px-4 py-3 flex justify-between items-center">
          <div className="flex items-center gap-2"><div className="w-8 h-8 bg-cyan-600 flex items-center justify-center font-black text-white italic clip-path-slant">MK</div>{isAdmin && <span className="bg-red-600 text-white text-[9px] px-1 rounded">ADMIN</span>}</div>
          <div className="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded-full border border-slate-700"><Wallet size={12} className="text-yellow-400" /><span className="text-xs font-bold text-white">₹{userProfile.walletBalance}</span></div>
      </div>

      <main className="max-w-md mx-auto">
          {view === 'home' && <HomeView />}
          {view === 'wallet' && <WalletView />}
          {view === 'profile' && <div className="p-4 text-center"><h2 className="text-white font-bold">{userProfile.displayName}</h2><Button onClick={()=>window.location.reload()} variant="danger" className="mt-4">LOGOUT</Button></div>}
      </main>

      {/* DYNAMIC JOIN MODAL */}
      {showJoinModal && joiningMatch && (
          <div className="fixed inset-0 z-50 bg-black/90 flex items-end sm:items-center justify-center">
              <div className="bg-slate-900 w-full max-w-sm p-6 rounded-t-3xl border-t border-cyan-500 max-h-[85vh] overflow-y-auto">
                  <h3 className="text-white font-bold mb-4 flex justify-between">
                      <span>JOIN {joiningMatch.mode} ({joiningMatch.time})</span>
                      <X onClick={()=>setShowJoinModal(false)}/>
                  </h3>
                  <div className="space-y-4 mb-4">
                      {playerDetails.map((p, i) => (
                          <div key={i} className="bg-black p-3 rounded-lg border border-slate-800">
                              <p className="text-[10px] text-cyan-500 font-bold mb-2">PLAYER {i+1} DETAILS</p>
                              <input placeholder={`Player ${i+1} Name`} className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs mb-2" 
                                onChange={(e)=>updatePlayer(i, 'name', e.target.value)} value={p.name}/>
                              <input placeholder="Free Fire UID" type="number" className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white text-xs" 
                                onChange={(e)=>updatePlayer(i, 'uid', e.target.value)} value={p.uid}/>
                          </div>
                      ))}
                  </div>
                  <Button onClick={confirmJoin} className="w-full">PAY ₹{joiningMatch.entryFee} & JOIN</Button>
              </div>
          </div>
      )}

      <div className="fixed bottom-0 w-full bg-slate-950/90 border-t border-slate-800 p-2 flex justify-around">
          <NavBtn icon={Gamepad2} label="ARENA" active={view==='home'} onClick={()=>setView('home')} />
          <NavBtn icon={Wallet} label="WALLET" active={view==='wallet'} onClick={()=>setView('wallet')} />
          <NavBtn icon={User} label="PROFILE" active={view==='profile'} onClick={()=>setView('profile')} />
      </div>
    </div>
  );
}

const NavBtn = ({icon: I, label, active, onClick}) => (
    <button onClick={onClick} className={`flex flex-col items-center ${active ? 'text-cyan-400' : 'text-slate-600'}`}>
        <I size={20} />
        <span className="text-[9px] font-bold mt-1">{label}</span>
    </button>
);


